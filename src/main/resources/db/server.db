-- 删除现有表（如果存在）
# DROP TABLE IF EXISTS time_slot;
# DROP TABLE IF EXISTS ordinary_schedule;
# DROP TABLE IF EXISTS course;
# DROP TABLE IF EXISTS sync_message;
# DROP TABLE IF EXISTS device;
# DROP TABLE IF EXISTS user;
DROP DATABASE IF EXISTS todoschedule;
CREATE DATABASE todoschedule;
USE todoschedule;

-- 创建用户表
CREATE TABLE user (
                                    id            INT AUTO_INCREMENT PRIMARY KEY,
                                    username      VARCHAR(50)                         NOT NULL,
                                    openid        VARCHAR(64)                         NULL COMMENT '微信openid',
                                    phone_number  VARCHAR(20)                         NULL,
                                    email         VARCHAR(100)                        NULL,
                                    avatar        VARCHAR(255)                        NULL,
                                    created_at    TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
                                    password_hash VARCHAR(255)                        NULL,
                                    last_open     TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
                                    token         VARCHAR(255)                        NULL,
                                    CONSTRAINT openid UNIQUE (openid),
                                    CONSTRAINT uk_email UNIQUE (email),
                                    CONSTRAINT uk_phone UNIQUE (phone_number),
                                    CONSTRAINT uk_username UNIQUE (username)
) COMMENT '用户表';

-- 创建设备表
CREATE TABLE device (
                        id                      VARCHAR(255)                        NOT NULL COMMENT '设备唯一标识符' PRIMARY KEY,
                        user_id                 INT                                 NOT NULL,
                        name                    VARCHAR(255)                        NULL COMMENT '设备名称',
                        last_sync_hlc_timestamp BIGINT    DEFAULT 0                 NULL COMMENT '此设备最后成功同步到的HLC时间戳',
                        created_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
                        updated_at              TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL ON UPDATE CURRENT_TIMESTAMP,
                        CONSTRAINT device_ibfk_1 FOREIGN KEY (user_id) REFERENCES user (id) ON DELETE CASCADE
) COMMENT '设备表';

CREATE INDEX user_id ON device (user_id);
CREATE INDEX idx_device_id ON device (id);

-- 创建CRDT消息存储表
CREATE TABLE sync_message (
                              id                 BIGINT AUTO_INCREMENT PRIMARY KEY COMMENT '消息唯一标识',
                              user_id            INT                                 NOT NULL,
                              entity_type        VARCHAR(50)                         NOT NULL COMMENT '实体类型，如: Course, OrdinarySchedule 等',
                              entity_key         VARCHAR(255)                        NOT NULL COMMENT '实体在CRDT模型中的唯一键 (即CRDT实体唯一键)',
                              message_data       TEXT                                NOT NULL COMMENT 'JSON格式的CRDT消息数据',
                              hlc_timestamp      BIGINT                              NOT NULL COMMENT '混合逻辑时钟时间戳',
                              origin_device_id   VARCHAR(255)                        NULL COMMENT '消息来源设备ID',
                              created_at         TIMESTAMP DEFAULT CURRENT_TIMESTAMP NOT NULL,
                              CONSTRAINT sync_message_ibfk_1 FOREIGN KEY (user_id) REFERENCES user (id) ON DELETE CASCADE
) COMMENT 'CRDT消息存储表';

CREATE INDEX idx_user_entity_hlc ON sync_message (user_id, entity_type, hlc_timestamp);
CREATE INDEX idx_user_entity_key_hlc ON sync_message (user_id, entity_type, entity_key, hlc_timestamp);

-- 创建课程表
CREATE TABLE course (
                        crdt_key      VARCHAR(255)                  NOT NULL COMMENT 'CRDT实体唯一键' PRIMARY KEY,
                        user_id       INT                           NOT NULL,
                        course_name   VARCHAR(100)                  NOT NULL,
                        color         VARCHAR(20) DEFAULT '#FF4081' NULL,
                        room          VARCHAR(50)                   NULL,
                        teacher       VARCHAR(50)                   NULL,
                        credit        FLOAT                         NULL,
                        course_code   VARCHAR(50)                   NULL,
                        syllabus_link VARCHAR(255)                  NULL,
                        start_node    INT                           NOT NULL,
                        step          INT                           NOT NULL,
                        day           INT                           NOT NULL,
                        start_week    INT                           NOT NULL,
                        end_week      INT                           NOT NULL,
                        week_type     INT          DEFAULT 0        NULL,
                        hlc_timestamp BIGINT       DEFAULT 0        NULL COMMENT '混合逻辑时钟时间戳',
                        is_deleted    TINYINT(1)   DEFAULT 0        NULL COMMENT '软删除标记',
                        deleted_at    TIMESTAMP                     NULL COMMENT '软删除时间',
                        CONSTRAINT course_ibfk_1 FOREIGN KEY (user_id) REFERENCES user (id) ON DELETE CASCADE
) COMMENT '课程表';

CREATE INDEX idx_course_crdt_key ON course (crdt_key);
CREATE INDEX idx_user_id ON course (user_id);
CREATE INDEX idx_course_hlc ON course (hlc_timestamp);

-- 创建普通日程表
CREATE TABLE ordinary_schedule (
                                   crdt_key      VARCHAR(255)               NOT NULL COMMENT 'CRDT实体唯一键' PRIMARY KEY,
                                   user_id       INT                        NOT NULL,
                                   title         VARCHAR(100)               NOT NULL,
                                   description   TEXT                       NULL,
                                   location      VARCHAR(255)               NULL,
                                   category      VARCHAR(50)                NULL,
                                   color         VARCHAR(20)                NULL,
                                   is_all_day    TINYINT(1)  DEFAULT 0      NULL,
                                   status        VARCHAR(20) DEFAULT 'TODO' NULL,
                                   start_time    VARCHAR(50)                NULL COMMENT '日程开始时间 YYYY-MM-DD HH:MM:SS',
                                   end_time      VARCHAR(50)                NULL COMMENT '日程结束时间 YYYY-MM-DD HH:MM:SS',
                                   priority      INT         DEFAULT 1      NULL,
                                   completed     TINYINT(1)  DEFAULT 0      NULL,
                                   hlc_timestamp BIGINT      DEFAULT 0      NULL COMMENT '混合逻辑时钟时间戳',
                                   is_deleted    TINYINT(1)  DEFAULT 0      NULL COMMENT '软删除标记',
                                   deleted_at    TIMESTAMP                  NULL COMMENT '软删除时间',
                                   CONSTRAINT ordinary_schedule_ibfk_1 FOREIGN KEY (user_id) REFERENCES user (id) ON DELETE CASCADE
) COMMENT '普通日程表';

CREATE INDEX idx_schedule_crdt_key ON ordinary_schedule (crdt_key);
CREATE INDEX idx_user_id ON ordinary_schedule (user_id);
CREATE INDEX idx_schedule_hlc ON ordinary_schedule (hlc_timestamp);

-- 创建时间槽表
CREATE TABLE time_slot (
                           crdt_key        VARCHAR(255)         NOT NULL COMMENT 'CRDT实体唯一键' PRIMARY KEY,
                           user_id         INT                  NOT NULL,
                           start_time      BIGINT               NOT NULL,
                           end_time        BIGINT               NOT NULL,
                           schedule_type   VARCHAR(20)          NOT NULL,
                           schedule_crdt_key VARCHAR(255)       NOT NULL COMMENT '关联的日程或课程CRDT键',
                           head            VARCHAR(100)         NULL,
                           priority        INT                  NULL,
                           is_completed    TINYINT(1) DEFAULT 0 NULL,
                           is_repeated     TINYINT(1) DEFAULT 0 NULL,
                           repeat_pattern  VARCHAR(100)         NULL,
                           reminder_type   VARCHAR(20)          NULL,
                           reminder_offset BIGINT               NULL,
                           is_notified     TINYINT(1) DEFAULT 0 NULL,
                           hlc_timestamp   BIGINT     DEFAULT 0 NULL COMMENT '混合逻辑时钟时间戳',
                           is_deleted      TINYINT(1) DEFAULT 0 NULL COMMENT '软删除标记',
                           deleted_at      TIMESTAMP            NULL COMMENT '软删除时间',
                           CONSTRAINT time_slot_ibfk_1 FOREIGN KEY (user_id) REFERENCES user (id) ON DELETE CASCADE
) COMMENT '时间槽表';

CREATE INDEX idx_timeslot_crdt_key ON time_slot (crdt_key);
CREATE INDEX idx_schedule_type_key ON time_slot (schedule_type, schedule_crdt_key);
CREATE INDEX idx_user_id ON time_slot (user_id);
CREATE INDEX idx_timeslot_hlc ON time_slot (hlc_timestamp);