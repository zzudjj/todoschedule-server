create table if not exists user
(
    id            int auto_increment
        primary key,
    username      varchar(50)                         not null,
    openid        varchar(64)                         null comment '微信openid',
    phone_number  varchar(20)                         null,
    email         varchar(100)                        null,
    avatar        varchar(255)                        null,
    created_at    timestamp default CURRENT_TIMESTAMP not null,
    password_hash varchar(255)                        null,
    last_open     timestamp default CURRENT_TIMESTAMP not null,
    token         varchar(255)                        null,
    constraint openid
        unique (openid),
    constraint uk_email
        unique (email),
    constraint uk_phone
        unique (phone_number),
    constraint uk_username
        unique (username)
)
    comment '用户表';

create table if not exists course
(
    crdt_key      varchar(255)                  not null comment 'CRDT实体唯一键'
        primary key,
    user_id       int                           not null,
    course_name   varchar(100)                  not null,
    color         varchar(20) default '#FF4081' null,
    room          varchar(50)                   null,
    teacher       varchar(50)                   null,
    credit        float                         null,
    course_code   varchar(50)                   null,
    syllabus_link varchar(255)                  null,
    start_node    int                           not null,
    step          int                           not null,
    day           int                           not null,
    start_week    int                           not null,
    end_week      int                           not null,
    week_type     int         default 0         null,
    hlc_timestamp bigint      default 0         null comment '混合逻辑时钟时间戳',
    is_deleted    tinyint(1)  default 0         null comment '软删除标记',
    deleted_at    timestamp                     null comment '软删除时间',
    constraint course_ibfk_1
        foreign key (user_id) references user (id)
            on delete cascade
)
    comment '课程表';

create index idx_course_crdt_key
    on course (crdt_key);

create index idx_course_hlc
    on course (hlc_timestamp);

create index idx_user_id
    on course (user_id);

create table if not exists device
(
    id                      varchar(255)                        not null comment '设备唯一标识符'
        primary key,
    user_id                 int                                 not null,
    name                    varchar(255)                        null comment '设备名称',
    last_sync_hlc_timestamp bigint    default 0                 null comment '此设备最后成功同步到的HLC时间戳',
    created_at              timestamp default CURRENT_TIMESTAMP not null,
    updated_at              timestamp default CURRENT_TIMESTAMP not null on update CURRENT_TIMESTAMP,
    constraint device_ibfk_1
        foreign key (user_id) references user (id)
            on delete cascade
)
    comment '设备表';

create index idx_device_id
    on device (id);

create index user_id
    on device (user_id);

create table if not exists ordinary_schedule
(
    crdt_key      varchar(255)               not null comment 'CRDT实体唯一键'
        primary key,
    user_id       int                        not null,
    title         varchar(100)               not null,
    description   text                       null,
    location      varchar(255)               null,
    category      varchar(50)                null,
    color         varchar(20)                null,
    is_all_day    tinyint(1)  default 0      null,
    status        varchar(20) default 'TODO' null,
    start_time    varchar(50)                null comment '日程开始时间 YYYY-MM-DD HH:MM:SS',
    end_time      varchar(50)                null comment '日程结束时间 YYYY-MM-DD HH:MM:SS',
    priority      int         default 1      null,
    completed     tinyint(1)  default 0      null,
    hlc_timestamp bigint      default 0      null comment '混合逻辑时钟时间戳',
    is_deleted    tinyint(1)  default 0      null comment '软删除标记',
    deleted_at    timestamp                  null comment '软删除时间',
    constraint ordinary_schedule_ibfk_1
        foreign key (user_id) references user (id)
            on delete cascade
)
    comment '普通日程表';

create index idx_schedule_crdt_key
    on ordinary_schedule (crdt_key);

create index idx_schedule_hlc
    on ordinary_schedule (hlc_timestamp);

create index idx_user_id
    on ordinary_schedule (user_id);

create table if not exists sync_message
(
    id               bigint auto_increment comment '消息唯一标识'
        primary key,
    user_id          int                                 not null,
    entity_type      varchar(50)                         not null comment '实体类型，如: Course, OrdinarySchedule 等',
    crdt_key         varchar(255)                        not null comment '实体在CRDT模型中的唯一键 (即CRDT实体唯一键)',
    message_data     text                                not null comment 'JSON格式的CRDT消息数据',
    hlc_timestamp    bigint                              not null comment '混合逻辑时钟时间戳',
    origin_device_id varchar(255)                        null comment '消息来源设备ID',
    created_at       timestamp default CURRENT_TIMESTAMP not null,
    constraint sync_message_ibfk_1
        foreign key (user_id) references user (id)
            on delete cascade
)
    comment 'CRDT消息存储表';

create index idx_user_entity_crdt_key_hlc
    on sync_message (user_id, entity_type, crdt_key, hlc_timestamp);

create index idx_user_entity_hlc
    on sync_message (user_id, entity_type, hlc_timestamp);

create table if not exists time_slot
(
    crdt_key          varchar(255)         not null comment 'CRDT实体唯一键'
        primary key,
    user_id           int                  not null,
    start_time        bigint               not null,
    end_time          bigint               not null,
    schedule_type     varchar(20)          not null,
    schedule_crdt_key varchar(255)         not null comment '关联的日程或课程CRDT键',
    head              varchar(100)         null,
    priority          int                  null,
    is_completed      tinyint(1) default 0 null,
    is_repeated       tinyint(1) default 0 null,
    repeat_pattern    varchar(100)         null,
    reminder_type     varchar(20)          null,
    reminder_offset   bigint               null,
    is_notified       tinyint(1) default 0 null,
    hlc_timestamp     bigint     default 0 null comment '混合逻辑时钟时间戳',
    is_deleted        tinyint(1) default 0 null comment '软删除标记',
    deleted_at        timestamp            null comment '软删除时间',
    constraint time_slot_ibfk_1
        foreign key (user_id) references user (id)
            on delete cascade
)
    comment '时间槽表';

create index idx_schedule_type_key
    on time_slot (schedule_type, schedule_crdt_key);

create index idx_timeslot_crdt_key
    on time_slot (crdt_key);

create index idx_timeslot_hlc
    on time_slot (hlc_timestamp);

create index idx_user_id
    on time_slot (user_id);

