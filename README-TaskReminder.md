# 微信任务提醒系统重构文档

## 重构概述

本次重构主要针对微信公众号任务提醒系统的代码结构和质量进行了全面优化，主要包括以下几个方面：

1. **数据持久化**: 将任务通知状态从内存缓存改为数据库字段存储，提高系统稳定性
2. **代码结构**: 使用工具类和常量类整理代码，提高可维护性
3. **XML处理**: 使用DOM4J替换手动XML解析，提高代码可读性和安全性
4. **网页授权**: 添加微信网页授权获取用户openid的功能，实现用户绑定
5. **代码重构**: 拆分大方法为小方法，明确职责，提高可读性

## 主要更新内容

### 1. 数据库结构优化

- 使用`time_slot`表中已存在的`is_notified`整数字段（0表示未通知，1表示已通知）
- 移除内存缓存机制，改用数据库字段存储通知状态，提高系统在重启后的稳定性

### 2. 代码结构优化

#### 2.1 工具类与常量类

- **Constants.java**: 集中管理系统中使用的常量值，包括消息类型、事件类型、日程类型和时间常量
- **WechatUtils.java**: 提供微信相关工具方法，如签名验证、字节转换等
- **XmlUtils.java**: 使用DOM4J处理XML解析和生成，替代手动解析

#### 2.2 实体类优化

- 在`TimeSlot`类中添加`isNotified`字段，与数据库对应
- 使用Lombok简化实体类代码，减少样板代码

#### 2.3 Mapper接口优化

- 添加`findNonNotifiedUpcomingTasks`方法，专门查询未通知的即将开始的任务
- 添加`markAsNotified`方法，用于更新通知状态
- 添加用户管理相关方法，支持通过openid查询和更新用户

### 3. 服务层优化

#### 3.1 提醒服务重构

- 移除内存缓存`notificationRecords`，使用数据库字段存储通知状态
- 移除过期通知清理方法，不再需要维护内存状态
- 直接查询未通知的任务，简化逻辑流程

#### 3.2 微信服务优化

- 使用DOM4J处理XML消息的生成和解析
- 优化模板消息构建逻辑

### 4. 网页授权功能

- 添加微信网页授权获取用户openid的功能
- 提供用户绑定和注册API
- 支持静默授权模式，提高用户体验
- 添加前端示例页面，展示授权流程和测试功能

### 5. 配置优化

- 启用SQL初始化配置，确保数据库表结构正确
- 添加更多注释，提高配置文件可读性
- 完善CORS配置，支持跨域请求

## 优化效果

### 1. 系统稳定性提升

- 应用重启后不会重复发送任务提醒，因为通知状态存储在数据库中
- 移除了内存缓存，降低了内存占用和OOM风险

### 2. 代码质量提升

- 代码可读性提高，职责分离更清晰
- 使用工具类和常量类减少重复代码
- 使用DOM4J处理XML，代码更安全、更标准

### 3. 用户体验提升

- 通过网页授权，轻松获取用户openid
- 用户无需手动输入或关注公众号即可绑定账号
- 一次授权，持久存储，提高用户体验

### 4. 可维护性提升

- 结构更清晰，模块职责明确
- 方法粒度更小，单一职责原则
- 配置和文档更完善

## 使用指南

### 数据库设置

数据库表结构已经完备，无需进行额外设置。`time_slot`表中包含以下重要字段：

- `id`: 主键
- `user_id`: 用户ID  
- `start_time`: 开始时间（时间戳）
- `end_time`: 结束时间（时间戳）
- `schedule_type`: 日程类型（普通任务、课程等）
- `schedule_id`: 关联到具体日程的ID
- `is_notified`: 通知状态（0=未通知，1=已通知）

`user`表中需要包含：
- `id`: 主键
- `username`: 用户名
- `openid`: 微信openid
- 其他用户信息字段

### 配置文件更新

确保`application.properties`中配置正确：

```properties
# 微信公众号配置
wechat.mp.appId=你的公众号AppID
wechat.mp.secret=你的公众号Secret
wechat.mp.token=你的公众号Token
wechat.mp.templates.reminder-template-id=你的模板消息ID

# 服务器URL配置 - 必须配置为公网可访问的域名
wechat.server-url=http://your-domain.com

# 微信网页授权成功页面 - 用于显示授权结果
wechat.oauth.success-page=http://your-domain.com/oauth-success.html
```

### 微信公众号配置

在微信公众平台进行以下配置：

1. **基本配置**:
   - 设置服务器地址为: `http://your-domain.com/wechat`
   - 设置Token和EncodingAESKey

2. **网页授权**:
   - 设置网页授权域名为: `your-domain.com`（不带http://）
   - 下载并保存验证文件到服务器根目录

3. **菜单配置**:
   - 添加一个菜单项，链接指向: `http://your-domain.com/oauth/authorize`

### 启动系统

```bash
mvn spring-boot:run
```

## 网页授权使用说明

### 授权流程

1. 用户访问授权链接: `http://your-domain.com/oauth/authorize?redirect_url=你的前端页面URL`
2. 系统重定向到微信授权页面
3. 用户同意授权
4. 微信重定向回系统的回调URL
5. 系统获取用户openid，并重定向到指定的前端页面URL，携带openid参数
6. 前端页面保存openid，用于后续API调用

### API接口

1. **注册用户**:
   ```
   POST /api/users/register
   {
     "username": "用户名",
     "openid": "用户的微信openid"
   }
   ```

2. **查询用户**:
   ```
   GET /api/users/by-openid/{openid}
   ```

3. **测试提醒**:
   ```
   GET /wechat/test-reminder?openid={openid}
   ```

## 注意事项

1. 系统使用数据库中的`is_notified`字段（0=未通知，1=已通知）记录提醒状态
2. 确保您的数据库连接配置正确，包括URL、用户名和密码
3. 网页授权域名必须配置，且必须是公网可访问的域名
4. 服务器需要有公网IP或域名，微信才能访问回调接口

## 后续优化方向

1. 添加单元测试和集成测试，提高代码质量
2. 增加缓存层，优化数据库查询性能
3. 完善前端页面，提供更好的用户交互体验
4. 完善日志记录，便于问题排查
5. 考虑引入消息队列，提高系统扩展性 